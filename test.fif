"common.fif" include

init_test

// add some test domains

"телеграм" 1 100 gen-test-addr domain_upsert 0 assert_eq
"yandex" 1 123 gen-test-addr domain_upsert 0 assert_eq
"stas"   1 124 gen-test-addr domain_upsert 0 assert_eq
"zevlg"  1 125 gen-test-addr domain_upsert 0 assert_eq
"yandex" 2 126 gen-test-addr domain_upsert 0 assert_eq
"faraway" -1 999 gen-test-addr domain_upsert 0 assert_eq
"faraway" 1 900 gen-test-addr domain_upsert 0 assert_eq
"" 2 303 gen-test-addr domain_upsert 35 assert_eq drop dec-mtdns-seqno
"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" 2 543 gen-test-addr domain_upsert 0 assert_eq
"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaX" 3 543 gen-test-addr domain_upsert 35 assert_eq drop dec-mtdns-seqno
"db1.msk.yandex" 1 400 gen-test-addr domain_upsert 0 assert_eq
"khv.yandex" 1 401 gen-test-addr domain_upsert 0 assert_eq

// resolve domains

"yandex" 1 get_dnsresolve 0 assert_eq 123 gen-test-addr assert_eq2 48 assert_eq
"yandex" 2 get_dnsresolve 0 assert_eq 126 gen-test-addr assert_eq2 48 assert_eq
"stas" 1 get_dnsresolve 0 assert_eq 124 gen-test-addr assert_eq2 32 assert_eq
"zevlg" 1 get_dnsresolve 0 assert_eq 125 gen-test-addr assert_eq2 40 assert_eq
"телеграм" 1 get_dnsresolve  0 assert_eq 100 gen-test-addr assert_eq2 128 assert_eq
"" 2 get_dnsresolve 0 assert_eq assert_null 0 assert_eq

"db1.msk.yandex" 1 get_dnsresolve 0 assert_eq 400 gen-test-addr assert_eq2 112 assert_eq
"db2.msk.yandex" 1 get_dnsresolve 0 assert_eq 123 gen-test-addr assert_eq2 48 assert_eq
"db2.khv.yandex" 1 get_dnsresolve 0 assert_eq 401 gen-test-addr assert_eq2 80 assert_eq

"..." 1 get_dnsresolve 0 assert_eq assert_null 0 assert_eq
"." 1 get_dnsresolve 0 assert_eq assert_null 0 assert_eq

// all records for a given domain
"yandex" get_dnsresolve_all 0 assert_eq 48 assert_eq

// -1 shadows all categories
"faraway" 1 get_dnsresolve 0 assert_eq 999 gen-test-addr assert_eq2 56 assert_eq
"faraway" 2 get_dnsresolve 0 assert_eq 999 gen-test-addr assert_eq2 56 assert_eq
"db.faraway" 3 get_dnsresolve 0 assert_eq 999 gen-test-addr assert_eq2 56 assert_eq
"mx.attic.faraway" 4 get_dnsresolve 0 assert_eq 999 gen-test-addr assert_eq2 56 assert_eq

// update

"uptest" 1 123 gen-test-addr domain_upsert 0 assert_eq
"uptest" 1 223 gen-test-addr domain_upsert 0 assert_eq
"uptest" 1 get_dnsresolve 0 assert_eq 223 gen-test-addr assert_eq2 48 assert_eq

// delete test

"deltest1" 1 100 gen-test-addr domain_upsert 0 assert_eq
"deltest1" 2 200 gen-test-addr domain_upsert 0 assert_eq
"deltest1" 3 300 gen-test-addr domain_upsert 0 assert_eq
"deltest1" 0 domain_delete 0 assert_eq
"deltest1" 1 get_dnsresolve 0 assert_eq assert_null 0 assert_eq
"deltest1" 2 get_dnsresolve 0 assert_eq assert_null 0 assert_eq
"deltest1" 4 get_dnsresolve 0 assert_eq assert_null 0 assert_eq

"deltest2" 1 100 gen-test-addr domain_upsert 0 assert_eq
"deltest2" 2 200 gen-test-addr domain_upsert 0 assert_eq
"deltest2" 2 domain_delete 0 assert_eq
"deltest2" 2 get_dnsresolve 0 assert_eq assert_null 0 assert_eq
"deltest2" 1 get_dnsresolve 0 assert_eq 100 gen-test-addr assert_eq2 64 assert_eq

"deltest3" 1 100 gen-test-addr domain_upsert 0 assert_eq
"deltest3" 2 200 gen-test-addr domain_upsert 0 assert_eq
"deltest3" 2 domain_delete 0 assert_eq
"deltest3" 1 domain_delete 0 assert_eq
"deltest3" 2 get_dnsresolve 0 assert_eq assert_null 0 assert_eq

// ownership transfer

variable new-pubkey
variable new-privkey
"test_transfer" load-generate-keypair new-privkey ! new-pubkey !
new-pubkey @ mtdns_transfer 0 assert_eq
// should work
"телеграм" 1 get_dnsresolve 0 assert_eq 100 gen-test-addr assert_eq2 128 assert_eq
// should fail with old sig
"telegram" 1 100 gen-test-addr domain_upsert 34 assert_eq drop dec-mtdns-seqno
new-pubkey @ mtdns-pubkey !
new-privkey @ mtdns-privkey !
// should work now
"telegram" 1 4242 gen-test-addr domain_upsert 0 assert_eq
"telegram" 1 get_dnsresolve 0 assert_eq 4242 gen-test-addr assert_eq2 64 assert_eq

// code upgrade

get_version 0 assert_eq triple third 1 assert_eq
"mtdns.fif" include mtdns_upgrade 0 assert_eq

// get seqno

get_seqno 0 assert_eq drop

// unknown op

mtdns_unknown_op 50 assert_eq drop dec-mtdns-seqno

// wrong seqno

dec-mtdns-seqno
"телеграм" 1 get_dnsresolve 0 assert_eq 100 gen-test-addr assert_eq2 128 assert_eq
"telega" 1 400 gen-test-addr domain_upsert 33 assert_eq drop
"telega" 1 400 gen-test-addr domain_upsert 0 assert_eq

."DONE" cr

// long domains (hash)
// nulls! (utf)

// emoji
// unify and list errcodes
// long opcodes?
// var -> type
